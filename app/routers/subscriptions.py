from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.orm import Session
from app import models
from app.database import get_db
from app.dependencies import get_current_user

router = APIRouter(prefix="/subscriptions", tags=["subscriptions"])

@router.get("/status")
def get_subscription_status(
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    subscription = db.query(models.Subscription).filter(
        models.Subscription.user_id == current_user.id
    ).first()
    status = subscription.status if subscription else "inactive"
    return {"status": status}

@router.post("/activate")
def activate_subscription(
    code: str = Query(..., description="C√≥digo de ativa√ß√£o enviado por e-mail"),
    db: Session = Depends(get_db),
    current_user: models.User = Depends(get_current_user)
):
    # üîë LISTA DE C√ìDIGOS V√ÅLIDOS ‚Äî ALTERE AQUI QUANDO PRECISAR
    VALID_CODES = [
        "H2A2025-0y06",
"H2A2025-1h07",
"H2A2025-0a08",
"H2A2025-2q09",
"H2A2025-1m10",
"H2A2025-3z11",
"H2A2025-0b12",
"H2A2025-4x13",
"H2A2025-2f14",
"H2A2025-1w15",
"H2A2025-3c16",
"H2A2025-0t17",
"H2A2025-2k18",
"H2A2025-1d19",
"H2A2025-4r20",
"H2A2025-3g21",
"H2A2025-0n22",
"H2A2025-2e23",
"H2A2025-1u24",
"H2A2025-3a25",
"H2A2025-0j26",
"H2A2025-4m27",
"H2A2025-2b28",
"H2A2025-1z29",
"H2A2025-3x30",
"H2A2025-0c31",
"H2A2025-2v32",
"H2A2025-1p33",
"H2A2025-4e34",
"H2A2025-3t35",
"H2A2025-0g36",
"H2A2025-2n37",
"H2A2025-1a38",
"H2A2025-4y39",
"H2A2025-3d40",
"H2A2025-0k41",
"H2A2025-2z42",
"H2A2025-1r43",
"H2A2025-4b44",
"H2A2025-3m45",
"H2A2025-0f46",
"H2A2025-2c47",
"H2A2025-1x48",
"H2A2025-4t49",
"H2A2025-3e50",
"H2A2025-0l51",
"H2A2025-2a52",
"H2A2025-1g53",
"H2A2025-4w54",
"H2A2025-3b55",
"H2A2025-0u56",
"H2A2025-2j57",
"H2A2025-1n58",
"H2A2025-4f59",
"H2A2025-3y60",
"H2A2025-0d61",
"H2A2025-2x62",
"H2A2025-1c63",
"H2A2025-4a64",
"H2A2025-3p65",
"H2A2025-0m66",
"H2A2025-2g67",
"H2A2025-1t68",
"H2A2025-4z69",
"H2A2025-3f70",
"H2A2025-0e71",
"H2A2025-2d72",
"H2A2025-1v73",
"H2A2025-4c74",
"H2A2025-3h75",
"H2A2025-0x76",
"H2A2025-2l77",
"H2A2025-1b78",
"H2A2025-4u79",
"H2A2025-3n80",
"H2A2025-0p81",
"H2A2025-2y82",
"H2A2025-1e83",
"H2A2025-4g84",
"H2A2025-3r85",
"H2A2025-0q86",
"H2A2025-2m87",
"H2A2025-1s88",
"H2A2025-4d89",
"H2A2025-3l90",
"H2A2025-0v91",
"H2A2025-2h92",
"H2A2025-1f93",
"H2A2025-4x94",
"H2A2025-3k95",
"H2A2025-0z96",
"H2A2025-2w97",
"H2A2025-1j98",
"H2A2025-4n99",
"H2A2025-3q100",
"H2A2025-0r101",
"H2A2025-2i102",
"H2A2025-1y103",
"H2A2025-4h104",
"H2A2025-3s105",
"H2A2025-0s106",
"H2A2025-2u107",
"H2A2025-1l108",
"H2A2025-4v109",
"H2A2025-3w110",
"H2A2025-0b111",
"H2A2025-2t112",
"H2A2025-1k113",
"H2A2025-4p114",
"H2A2025-3z115",
"H2A2025-0a116",
"H2A2025-2r117",
"H2A2025-1h118",
"H2A2025-4q119",
"H2A2025-3j120",
"H2A2025-0y121",
"H2A2025-2s122",
"H2A2025-1i123",
"H2A2025-4o124",
"H2A2025-3u125",
"H2A2025-0n126",
"H2A2025-2q127",
"H2A2025-1m128",
"H2A2025-4r129",
"H2A2025-3c130",
"H2A2025-0t131",
"H2A2025-2f132",
"H2A2025-1w133",
"H2A2025-4x134",
"H2A2025-3g135",
"H2A2025-0j136",
"H2A2025-2k137",
"H2A2025-1d138",
"H2A2025-4m139",
"H2A2025-3x140",
"H2A2025-0c141",
"H2A2025-2v142",
"H2A2025-1p143",
"H2A2025-4e144",
"H2A2025-3t145",
"H2A2025-0g146",
"H2A2025-2n147",
"H2A2025-1a148",
"H2A2025-4y149",
"H2A2025-3d150",
"H2A2025-0k151",
"H2A2025-2z152",
"H2A2025-1r153",
"H2A2025-4b154",
"H2A2025-3m155",
"H2A2025-0f156",
"H2A2025-2c157",
"H2A2025-1x158",
"H2A2025-4t159",
"H2A2025-3e160",
"H2A2025-0l161",
"H2A2025-2a162",
"H2A2025-1g163",
"H2A2025-4w164",
"H2A2025-3b165",
"H2A2025-0u166",
"H2A2025-2j167",
"H2A2025-1n168",
"H2A2025-4f169",
"H2A2025-3y170",
"H2A2025-0d171",
"H2A2025-2x172",
"H2A2025-1c173",
"H2A2025-4a174",
"H2A2025-3p175",
"H2A2025-0m176",
"H2A2025-2g177",
"H2A2025-1t178",
"H2A2025-4z179",
"H2A2025-3f180",
"H2A2025-0e181",
"H2A2025-2d182",
"H2A2025-1v183",
"H2A2025-4c184",
"H2A2025-3h185",
"H2A2025-0x186",
"H2A2025-2l187",
"H2A2025-1b188",
"H2A2025-4u189",
"H2A2025-3n190",
"H2A2025-0p191",
"H2A2025-2y192",
"H2A2025-1e193",
"H2A2025-4g194",
"H2A2025-3r195",
"H2A2025-0q196",
"H2A2025-2m197",
"H2A2025-1s198",
"H2A2025-4d199",
"H2A2025-3l200",
"H2A2025-0v201",
"H2A2025-2h202",
"H2A2025-1f203"

    ]

    if code not in VALID_CODES:
        raise HTTPException(status_code=400, detail="C√≥digo de ativa√ß√£o inv√°lido ou j√° usado")

    # Ativa a assinatura do usu√°rio logado
    subscription = db.query(models.Subscription).filter(
        models.Subscription.user_id == current_user.id
    ).first()

    if not subscription:
        subscription = models.Subscription(user_id=current_user.id)

    subscription.status = "active"
    db.add(subscription)
    db.commit()

    return {"message": "Assinatura ativada com sucesso!"}
